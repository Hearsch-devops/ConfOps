stages:
  - build
  - deploy

variables:
  IMAGE_NAME: "${DOCKER_USERNAME}/conference-backend"
  DOCKER_TLS_CERTDIR: ""

build:
  stage: build
  image: docker:24.0.2
  tags:
    - "conf"
    - "room"
  services:
    - name: docker:24-dind
  before_script:
    - echo "Logging into Docker Hub"
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - echo "Building Docker image $IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - docker build -t "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" -f Conference-setup/Dockerfile .
    - docker push "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - docker tag "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" "$IMAGE_NAME:latest"
    - docker push "$IMAGE_NAME:latest"
  only:
    - main
    - master

deploy:
  image: alpine/k8s:1.29.15
  tags:
    - "conf"
    - "room"
  stage: deploy
  before_script:
    - export KUBECONFIG="$KUBE_CONFIG"
    - echo "Using kubeconfig:"
    - kubectl config view
  script:
    - kubectl get nodes --insecure-skip-tls-verify
    - echo "Applying namespace manifests first"
    - kubectl apply -f Kubernetes-setup/**/namespace-*.yaml || true
    - echo "Applying remaining Kubernetes manifests"
    - kubectl apply -f Kubernetes-setup/
    - kubectl apply -f Kubernetes-setup/monitoring/
    - kubectl set image deployment/flask-deployment flask="$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" --record
    - kubectl rollout status deployment/flask-deployment
  only:
    - main
    - master
    